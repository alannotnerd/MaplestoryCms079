package net.sf.cherry.client.messages.commands;

import net.sf.cherry.client.MapleCharacter;
import net.sf.cherry.client.MapleClient;
import net.sf.cherry.client.messages.Command;
import net.sf.cherry.client.messages.CommandDefinition;
import net.sf.cherry.client.messages.IllegalCommandSyntaxException;
import net.sf.cherry.client.messages.MessageCallback;
import net.sf.cherry.database.DatabaseConnection;
import net.sf.cherry.net.MaplePacket;
import net.sf.cherry.net.channel.ChannelServer;
import net.sf.cherry.server.TimerManager;
import net.sf.cherry.server.life.MapleLifeFactory;
import net.sf.cherry.server.life.MapleNPC;
import net.sf.cherry.server.maps.MapleMapObject;
import net.sf.cherry.server.maps.MapleMapObjectType;
import net.sf.cherry.tools.MaplePacketCreator;

import java.awt.*;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.List;


public class NPCSpawningCommands implements Command {

  @Override
  public void execute(MapleClient c, MessageCallback mc, String[] splitted) throws Exception {
    if (splitted[0].equals("!创建临时npc")) {
      int npcId = Integer.parseInt(splitted[1]);
      MapleNPC npc = MapleLifeFactory.getNPC(npcId);
      if (npc != null && !npc.getName().equals("MISSINGNO")) {
        npc.setPosition(c.getPlayer().getPosition());
        npc.setCy(c.getPlayer().getPosition().y);
        npc.setRx0(c.getPlayer().getPosition().x + 50);
        npc.setRx1(c.getPlayer().getPosition().x - 50);
        npc.setFh(c.getPlayer().getMap().getFootholds().findBelow(c.getPlayer().getPosition()).getId());
        npc.setCustom(true);
        c.getPlayer().getMap().addMapObject(npc);
        c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.spawnNPC(npc));
      } else {
        mc.dropMessage("You have entered an invalid NPC ID.");
      }
    } else if (splitted[0].equals("!创建永久npc")) {
      MapleCharacter player = c.getPlayer();
      int npcId = Integer.parseInt(splitted[1]);
      MapleNPC npc = MapleLifeFactory.getNPC(npcId);
      int xpos = player.getPosition().x;
      int ypos = player.getPosition().y;
      int fh = player.getMap().getFootholds().findBelow(player.getPosition()).getId();
      if (npc != null && !npc.getName().equals("MISSINGNO")) {
        npc.setPosition(player.getPosition());
        npc.setCy(ypos);
        npc.setRx0(xpos + 50);
        npc.setRx1(xpos - 50);
        npc.setFh(fh);
        npc.setCustom(true);
        try {
          Connection con = DatabaseConnection.getConnection();
          PreparedStatement ps = con.prepareStatement("INSERT INTO spawns ( idd, f, fh, cy, rx0, rx1, type, x, y, mid ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )");
          ps.setInt(1, npcId);
          ps.setInt(2, 0);
          ps.setInt(3, fh);
          ps.setInt(4, ypos);
          ps.setInt(4, ypos);
          ps.setInt(5, xpos + 50);
          ps.setInt(6, xpos - 50);
          ps.setString(7, "n");
          ps.setInt(8, xpos);
          ps.setInt(9, ypos);
          ps.setInt(10, player.getMapId());
          ps.executeUpdate();
        } catch (SQLException e) {
          mc.dropMessage("Failed to save NPC to the database");
        }
        player.getMap().addMapObject(npc);
        player.getMap().broadcastMessage(MaplePacketCreator.spawnNPC(npc));
      } else {
        mc.dropMessage("你应该输入一个正确的 Npc-Id");
      }
    } else if (splitted[0].equals("!removenpcs")) {
      MapleCharacter player = c.getPlayer();
      List<MapleMapObject> npcs = player.getMap().getMapObjectsInRange(c.getPlayer().getPosition(), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.NPC));
      for (MapleMapObject npcmo : npcs) {
        MapleNPC npc = (MapleNPC) npcmo;
        if (npc.isCustom()) {
          player.getMap().removeMapObject(npc.getObjectId());
        }
      }
    } else if (splitted[0].equals("!mynpcpos")) {
      Point pos = c.getPlayer().getPosition();
      mc.dropMessage("CY: " + pos.y + " | RX0: " + (pos.x + 50) + " | RX1: " + (pos.x - 50) + " | FH: " + c.getPlayer().getMap().getFootholds().findBelow(pos).getId());
    } else if (splitted[0].equals("!jqevent")) {
      String map = splitted[1];
      int minutes = Integer.parseInt(splitted[2]);
      int npcid = 0;
      if (map.equals("fitness")) {
        npcid = 2042003;
      } else if (map.equals("chimney")) {
        npcid = 9300012;
      }
      final MapleNPC npc = MapleLifeFactory.getNPC(npcid);
      npc.setPosition(c.getPlayer().getPosition());
      npc.setCy(c.getPlayer().getPosition().y);
      npc.setRx0(c.getPlayer().getPosition().x + 50);
      npc.setRx1(c.getPlayer().getPosition().x - 50);
      npc.setFh(c.getPlayer().getMap().getFootholds().findBelow(c.getPlayer().getPosition()).getId());
      npc.setCustom(true);
      c.getPlayer().getMap().addMapObject(npc);
      c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.spawnNPC(npc));
      MaplePacket msgpacket = MaplePacketCreator.serverNotice(6, "The NPC " + npc.getName() + " will be in " + c.getPlayer().getMap().getMapName() + " for " + minutes + "minute(s). Please talk to it to be warped to the JQ Event");
      ChannelServer.getInstance(c.getChannel()).getWorldInterface().broadcastMessage(c.getPlayer().getName(), msgpacket.getBytes());
      final MapleCharacter player = c.getPlayer();
      TimerManager.getInstance().schedule(new Runnable() {
        @Override
        public void run() {
          List<MapleMapObject> npcs = player.getMap().getMapObjectsInRange(player.getPosition(), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.NPC));
          for (MapleMapObject npcmo : npcs) {
            MapleNPC fnpc = (MapleNPC) npcmo;
            if (fnpc.isCustom() && fnpc.getId() == npc.getId()) {
              player.getMap().removeMapObject(fnpc.getObjectId());
            }
          }
        }
      }, minutes * 60 * 1000);
    }
  }

  @Override
  public CommandDefinition[] getDefinition() {
    return new CommandDefinition[]{
        new CommandDefinition("创建临时npc", "npcid", "Spawns the npc with the given id at the player position", 50),
        new CommandDefinition("创建永久npc", "npcid", "Spawns the npc with the given id at the player position", 50)
        //new CommandDefinition("removenpcs", "", "Removes all custom spawned npcs from the map - requires reentering the map", 50),
        //new CommandDefinition("mynpcpos", "", "Gets the info for making an npc", 50),
        //new CommandDefinition("jqevent", "<chimney, fitness>", "Spawns an NPC for a JQ Event", 50)
    };
  }
}